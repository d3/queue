(function(){function n(n){function t(){for(;r=f.length>a&&n>p;){var t=a++,u=f[t],l=i.call(u,1);l.push(e(t)),++p,u[0].apply(null,l)}}function e(n){return function(u,e){--p,null==h&&(null!=u?(h=u,a=s=0/0,l()):(f[n]=e,--s?r||t():l()))}}function l(){null!=h?d(h):c?d(h,f):d.apply(null,[h].concat(f))}var o,r,c,f=[],a=0,p=0,s=0,h=null,d=u;return n||(n=1/0),o={defer:function(){return h||(f.push(arguments),++s,t()),o},await:function(n){return d=n,c=!1,s||l(),o},awaitAll:function(n){return d=n,c=!0,s||l(),o}}}function t(n){return{then:function(u,i){var l=e;return i||(i=e),n(function(n,t){function e(n){try{l(null,n?i.call(this,n):u.apply(this,[].slice.call(arguments,1)))}catch(n){l(n)}}n?e(n):t.await(e)}),t(function(n){l=n})}}}function u(){}function e(n){if(n)throw n}var i=[].slice;n.then=function(n){var u=n();return t(function(n){n(null,u)})},n.version="1.0.7","function"==typeof define&&define.amd?define(function(){return n}):"object"==typeof module&&module.exports?module.exports=n:this.queue=n})();